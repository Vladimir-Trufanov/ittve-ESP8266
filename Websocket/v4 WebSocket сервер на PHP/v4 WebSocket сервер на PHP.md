## [v4 WebSocket сервер на PHP](https://tokmakov.msk.ru/blog/item/202)

### Общие рекомендации по запуску PHP-скриптов в командной строке Windows:

- Откройте командную строку. Для этого зажмите сочетание клавиш Win+R, введите «***cmd***» и нажмите ***Enter***. 

- Убедитесь, что PHP установлен в системе. Чтобы проверить наличие PHP и узнать установленную версию, введите ***php -v***. Если PHP не установлен, загрузите и установите его с официального сайта PHP. 

- Создайте PHP-скрипт, используя любой текстовый редактор. 

- Запустите скрипт. В командной строке пропишите команду ***php script.php***. 

- Также рекомендуется добавить путь до PHP в переменную окружения PATH в Windows. Это позволит не указывать каждый раз полный путь до файла php.exe. 

### Как пользоваться TelNet в Windows 11:

Чтобы пользоваться Telnet в Windows 11, необходимо включить эту функцию через настройки операционной системы:

- Откройте «Панель управления». Для этого нажмите клавиши Win + R на клавиатуре (либо правой кнопкой мыши по кнопке «Пуск» и выберите пункт «Выполнить»).

- Введите ***appwiz.cpl*** и нажмите ***Enter***. В открывшемся окне в панели слева нажмите по пункту «***Включение или отключение компонентов Windows***». 

- Отметьте «***Клиент Telnet***» в списке доступных компонентов и нажмите «***Ок***».  Дождитесь, когда клиент Telnet будет установлен. 

- Для начала использования достаточно будет запустить командную строку, ввести команду ***telnet*** и нажать ***Enter***. 

Важно учитывать риски безопасности при использовании Telnet, так как он отправляет данные в открытом виде. Это может привести к подслушиванию конфиденциальной информации, например, имён пользователей и паролей.

### [v4 WebSocket сервер на PHP](https://tokmakov.msk.ru/blog/item/202)

Протокол WebSocket предназначен для решения разных задач и снятия ограничений обмена данными между браузером и сервером. Он позволяет пересылать любые данные, на любой домен, безопасно и почти без лишнего сетевого трафика. Для установления соединения WebSocket клиент и сервер используют протокол, похожий на HTTP. Клиент формирует особый HTTP-запрос, на который сервер отвечает определенным образом.

#### 1. Simple.php Простой сокет-сервер

В первую очередь надо в файле php.ini расскомментировать строку, позволяющую работать с сокетами и перезапустить сервер:

```
extension = php_sockets.dll
```

Простой сокет-сервер представлен файлом ***Simple.php***. Запуск из командной строки и ответы сервера выглядят след.образом: 

```
php.exe -f Simple.php

SERVER START
Socket create...
Socket bind...
Set option...
Listening socket...
Waiting for connections...
```

Попробуем пообщаться с сервером с помощью telnet:

```
> telnet
```
Получив приглашение telnet, даем команду:

```
> open 127.0.0.1 7777

Hello, Client!
```

#### 2. Echo-server  - второй сокет-сервер

Вначале делаем сайт для клиента на ***localhost:89*** из ***index.html, socket.js, style.css***. Пытаемся соединиться с ***ws://echo.websocket.org***. Не получилось, ошибка 1006.

Но, когда заменил на ***wss://echo.websocket.org*** получился вот такой диалог:

```
Соединение с сервером установлено
Получено сообщение от сервера: Request served by 1781505b56ee58
Отправлено сообщение серверу: Привет!
Получено сообщение от сервера: Привет!
```
#### 3. [echo-websocket-org](https://websocket.org/tools/websocket-echo-server)

В данном каталоге загружен подправленный клиент со страницы ***https://echo.websocket.org/.ws*** и снятый со [страницы](https://echo.websocket.org/) тестовый сервер ***echo-websocket-org***.

```
Request served by 1781505b56ee58

GET / HTTP/1.1

Host: echo.websocket.org
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: ru,en;q=0.9,ko;q=0.8
Cookie: _ga=GA1.1.703122278.1742325685; _ga_BZ0LYEZXEJ=GS1.1.1742539519.2.1.1742542051.0.0.0
Fly-Client-Ip: 94.140.245.110
Fly-Forwarded-Port: 443
Fly-Forwarded-Proto: https
Fly-Forwarded-Ssl: on
Fly-Region: fra
Fly-Request-Id: 01JPVSNE3231E4KGBB0T3ET5PC-fra
Priority: u=0, i
Sec-Ch-Ua: "Not A(Brand";v="8", "Chromium";v="132", "YaBrowser";v="25.2", "Yowser";v="2.5"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 YaBrowser/25.2.0.0 Safari/537.36
Via: 2 fly.io, 2 fly.io
X-Forwarded-For: 94.140.245.110, 66.241.124.119
X-Forwarded-Port: 443
X-Forwarded-Proto: https
X-Forwarded-Ssl: on
X-Request-Start: t=1742542125154757
```
#### 4. Делаем сервер: ***echo-server.php***

Поработали с ***echo.websocket.org***, делаем свой сервер. 
Запускаем сервер из командной строки:

```
php.exe -f echo-server.php
```
#### 5. "Клиент отправляет команды, а сервер их выполняет"

Делаем сервер на порту ***7773*** с тем-же клиентом: ***com-server.php***.

---

***Defined Status Codes***

- 1000 CLOSE_NORMAL. 1000 указывает на нормальное завершение работы, то есть на то, что цель, ради которой было установлено соединение, достигнута.

- 1001 CLOSE_GOING_AWAY. 1001 означает, что конечная точка «закрывается», например, сервер выходит из строя или браузер переходит на другую страницу.

- 1002 CLOSE_PROTOCOL_ERROR. 1002 указывает на то, что конечная точка завершает соединение из-за ошибки протокола.

- 1003 CLOSE_UNSUPPORTED. 1003 указывает на то, что конечная точка завершает соединение, поскольку получила тип данных, который она не может принять (например, конечная точка, которая понимает только текстовые данные, МОЖЕТ отправить этот код, если получит двоичное сообщение).

- 1004 Зарезервировано. Конкретное значение может быть определено в будущем.

- 1005 CLOSED_NO_STATUS. 1005 — это зарезервированное значение, которое НЕ ДОЛЖНО использоваться в качестве кода состояния в кадре управления закрытием конечной точкой. Оно предназначено для использования в приложениях, ожидающих код состояния, указывающий на отсутствие кода состояния.

- 1006 CLOSE_ABNORMAL. 1006 — это зарезервированное значение, которое НЕ ДОЛЖНО использоваться в качестве кода состояния в управляющем кадре закрытия конечной точкой. Оно предназначено для использования в приложениях, ожидающих код состояния, указывающий на то, что соединение было закрыто ненормально, например, без отправки или получения управляющего кадра закрытия:

```
a) клиент сокета в браузере работал не по протоколу сервера сокета;
б) истекло максимально заданное время работы сервера сокета.
```

- 1007 Unsupported payload. 1007 означает, что конечная точка завершает соединение, так как получила данные в сообщении, которые не соответствуют типу сообщения (например, данные, отличные от UTF-8 [RFC3629], в текстовом сообщении).

- 1008 Policy violation. 1008 указывает на то, что конечная точка завершает соединение, поскольку получила сообщение, нарушающее её политику. Это общий код состояния, который может быть возвращён, если нет другого более подходящего кода состояния (например, 1003 или 1009) или если необходимо скрыть конкретные сведения о политике.

- 1009 CLOSE_TOO_LARGE. 1009 означает, что конечная точка завершает соединение, так как получила слишком большое для обработки сообщение.

- 1010 Mandatory extension - Обязательное продление. 1010 указывает на то, что конечная точка (клиент) завершает соединение, так как ожидала, что сервер согласует одно или несколько расширений, но сервер не вернул их в ответном сообщении при установлении соединения WebSocket. Списокнеобходимых расширений ДОЛЖЕН отображаться в части /reason/ кадра закрытия. Обратите внимание, что этот код состояния не используется сервером, так как он может привести к сбою при установлении соединения WebSocket.

- 1011 Server error. 1011 означает, что сервер завершает соединение, так как столкнулся с непредвиденной ситуацией, которая помешала ему выполнить запрос.

- 1012 Service restart - Перезапуск службы. 1012 указывает, что сервер / служба перезапускается.

- 1013 Try again later - Попробуйте еще раз позже. 1013 указывает на то, что временное состояние сервера вынудило его заблокировать запрос клиента.

1014 Bad gateway - Плохие врата. 1014 означает, что сервер, выступающий в качестве шлюза, получил неверный ответ.

1015 TLS handshake fail - Сбой рукопожатия TLS. 1015 является зарезервированным значением и НЕ ДОЛЖЕН использоваться в качестве кода состояния в кадре управления закрытием конечной точкой. Он предназначен для использования в приложениях, ожидающих код состояния, указывающий на то, что соединение было закрыто из-за невозможности выполнить рукопожатие TLS (например, сертификат сервера не может быть проверен).

***Reserved Status Code Ranges***

- 0-999. Коды состояния в диапазоне 0-999 не используются.

- 1000-2999. Коды состояния в диапазоне 1000–2999 зарезервированы для определения в рамках этого протокола, его будущих версий и расширений, указанных в постоянной и общедоступной спецификации.

- 3000-3999. Коды состояния в диапазоне 3000-3999 зарезервированы для использования библиотеками, фреймворками и приложениями. Эти коды состояния зарегистрированы непосредственно в IANA. Интерпретация этих кодов не определена данным протоколом.

- 4000-4999. Коды состояния в диапазоне 4000-4999 зарезервированы для частного использования и, следовательно, не могут быть зарегистрированы. Такие коды могут использоваться по предварительным соглашениям между приложениями WebSocket. Толкование этих кодов настоящим протоколом не определено.


### Библиография

#### [web-socket-server](https://github.com/tokmakov/web-socket-server)

#### [WebSocket](https://learn.javascript.ru/websockets)

#### [The WebSocket Protocol](https://datatracker.ietf.org/doc/html/rfc6455#section-7.4)
